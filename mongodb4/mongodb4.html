<script type="text/javascript">
	RED.nodes.registerType("mongodb4-client", {
		category: "config",
		defaults: {
			name: { value: "" },
			protocol: { value: "mongodb", required: true },
			hostname: { value: "", required: true },
			port: { value: "27017", required: true },
			dbName: { value: "", required: true },
			authSource: { value: "" },
			authMechanism: { value: "SCRAM-SHA-256" },
			tls: { value: false },
			tlsCAFile: { value: "" },
			tlsInsecure: { value: false },
		},
		credentials: {
			username: { value: "", type: "text" },
			password: { value: "", type: "password" },
		},
		label: function () {
			return this.name || `${this.hostname} ${this.dbName}`;
		},
	});
</script>

<script type="text/html" data-template-name="mongodb4-client">
  <div class="form-row">
    <label for="node-config-input-protocol"
      ><i class="fa fa-envelope-o"></i> Protocol</label
    >
    <select id="node-config-input-protocol">
      <option value="mongodb">toArray</option>
      <option value="mongodb+srv">forEach</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-config-input-hostname"
      ><i class="fa fa-server"></i> Hostname</label
    >
    <input type="text" id="node-config-input-hostname" />
  </div>
  <div class="form-row">
    <label for="node-config-input-port"><i class="fa fa-plug"></i> Port</label>
    <input type="text" id="node-config-input-port" placeholder="27017" />
  </div>
  <div class="form-row">
    <label for="node-config-input-dbName"
      ><i class="fa fa-database"></i> Database</label
    >
    <input type="text" id="node-config-input-dbName" placeholder="my-database" />
  </div>
  <div class="form-row">
    <label for="node-config-input-username"
      ><i class="fa fa-user"></i> Username</label
    >
    <input type="text" id="node-config-input-username" />
  </div>
  <div class="form-row">
    <label for="node-config-input-password"
      ><i class="fa fa-unlock-alt"></i> Password</label
    >
    <input type="password" id="node-config-input-password" />
  </div>
  <div class="form-row">
    <label for="node-config-input-authSource"
      ><i class="fa fa-id-card-o"></i> AuthSource</label
    >
    <input type="text" id="node-config-input-authSource" placeholder="my-database" />
  </div>
  <div class="form-row">
    <label for="node-config-input-authMechanism"
      ><i class="fa fa-key"></i> AuthMech</label
    >
    <select id="node-config-input-authMechanism">
      <option value="SCRAM-SHA-256">SCRAM-SHA-256</option>
      <option value="SCRAM-SHA-1">SCRAM-SHA-1</option>
      <option value="MONGODB-CR">MONGODB-CR</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-config-input-tls"
      ><i class="fa fa-handshake-o"></i> TLS</label
    >
    <input type="checkbox" id="node-config-input-tls" />
  </div>
  <div class="form-row">
    <label for="node-config-input-tlsCAFile"
      ><i class="fa fa-certificate"></i>TLS CA-File</label
    >
    <input type="text" id="node-config-input-tlsCAFile" placeholder="/data/cert/ca.cer" />
  </div>
  <div class="form-row">
    <label for="node-config-input-tlsInsecure"
      ><i class="fa fa-ban"></i> TLS-Insecure</label
    >
    <input type="checkbox" id="node-config-input-tlsInsecure" />
  </div>
  <div class="form-row">
    <label for="node-config-input-advanced"><i class="fa fa-cogs"></i> Advanced</label>
    <input type="text" id="node-config-input-advanced" placeholder="{}" />
  </div>
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" />
  </div>
</script>

<script type="text/markdown" data-help-name="mongodb4-client">
Configuration node for MongoDB connection config.
Node will create a MongoDB Client.

### Protocol
`mongodb` or `mongodb+srv`

### Hostname
Hostname / IP to connect to MongoDB

### Port
Default port is 27017.

### Database
A MongoDB database name.

### AuthSource
Specify the database name associated with the userâ€™s credentials.

### AuthMech
Specify the authentication mechanism that MongoDB will use to authenticate the connection.

### TLS CA-File
Specifies the location of a local .pem file that contains the root certificate chain from the Certificate Authority. This file is used to validate the certificate presented by the mongod/mongos instance.

### TLS-Insecure
Disables various certificate validations. THIS IS REALLY NOT SECURE.

### Advanced
MongoDB Driver 4 MongoClient supports more options. Feel free to overwrite all client options with your own JSON-Config-String.
[MongoClientOptions](https://mongodb.github.io/node-mongodb-native/4.2/interfaces/MongoClientOptions.html)
</script>

<script type="text/javascript">
	RED.nodes.registerType("mongodb4", {
		category: "storage-input",
		color: "#3FA037",
		defaults: {
			clientNode: { type: "mongodb4-client" },
			collection: { value: "" },
			operation: { value: "" },
			output: { value: "toArray" },
			name: { value: "" },
		},
		inputs: 1,
		outputs: 1,
		icon: "db.svg",
		label: function () {
			return this.name || this.operation || "mongodb4";
		},
	});
</script>

<script type="text/html" data-template-name="mongodb4">
  <div class="form-row">
    <label for="node-input-clientNode"
      ><i class="fa fa-server"></i> Connection</label
    >
    <input type="text" id="node-input-clientNode" />
  </div>
  <div class="form-row">
    <label for="node-input-collection"
      ><i class="fa fa-archive"></i> Collection</label
    >
    <input
      type="text"
      id="node-input-collection"
      placeholder="msg.collection"
    />
  </div>
  <div class="form-row">
    <label for="node-input-operation"
      ><i class="fa fa-code"></i> Operation</label
    >
    <input type="text" id="node-input-operation" placeholder="msg.operation" />
  </div>
  <div class="form-row">
    <label for="node-input-output"><i class="fa fa-sign-out"></i> Output</label>
    <select id="node-input-output">
      <option value="toArray">toArray</option>
      <option value="forEach">forEach</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
</script>

<script type="text/markdown" data-help-name="mongodb4">
Execute MongoDB collection operations with this node.

### Connection

Select a MongoDB database server connection.

### Collection

MongoDB database collection static definition or with `msg.collection`

### Operation

A MongoDB Driver 4 collection CRUD operation for example `find`, `insertOne`, `updateOne`, `aggregate` and many more.

Read the full documentation here: [Collection-API](https://mongodb.github.io/node-mongodb-native/4.2/classes/Collection.html)

### Payload Input

Pass the CRUD operation arguments as message payload.
Message payload has to be array type to pass multiple function arguments to driver operation.
Example: `msg.payload = [{_id: '123'},{fields: {...}}]`.
The payload array will be passed as function arguments for the MongoDB driver collection operation, like so: `collection.find({_id: '123'}, {fields: {...}})`

More information here:
[Collection-API](https://mongodb.github.io/node-mongodb-native/4.2/classes/Collection.html)

### Payload Output

The node will output the database driver response as message payload.
The operations `aggregate` and `find` can output with `toArray` or `forEach`.

### More information

[Visit the MongoDB Driver 4 Docs](https://docs.mongodb.com/drivers/node/current/)
</script>